# 故障排除指南

本指南提供了解决常见问题的方法和调试提示。

## 身份验证

- **错误：`登录失败。消息：请求包含无效参数`**
  - 使用 Google Workspace 账户的用户，或使用与 Gmail 账户关联的 Google Cloud 账户的用户可能无法激活 Google Code Assist 套餐的免费层级。
  - 对于 Google Cloud 账户，可以通过将 `GOOGLE_CLOUD_PROJECT` 设置为您的项目 ID 来解决此问题。
  - 您还可以从 [AI Studio](https://aistudio.google.com/app/apikey) 获取一个 API 密钥，该密钥也包含单独的免费层级。

## 常见问题解答（FAQ）

- **问：如何将 Gemini CLI 更新到最新版本？**
  - 答：如果通过 npm 全局安装，请使用命令 `npm install -g @google/gemini-cli@latest` 更新 Gemini CLI。如果从源代码运行，请从仓库中拉取最新更改，并使用 `npm run build` 重新构建。

- **问：Gemini CLI 的配置文件存储在哪里？**
  - 答：CLI 配置存储在两个 `settings.json` 文件中：一个位于您的主目录中，另一个位于项目的根目录中。在这两个位置，`.iflycode/` 文件夹中都可以找到 `settings.json`。有关更多详细信息，请参阅 [CLI 配置](./cli/configuration.md)。

- **问：为什么在我的统计输出中看不到缓存的令牌计数？**
  - 答：只有在使用缓存令牌时才会显示缓存的令牌信息。此功能适用于 API 密钥用户（Gemini API 密钥或 Vertex AI），但目前不适用于 OAuth 用户（Google 个人/企业账户），因为 Code Assist API 不支持创建缓存内容。您仍可以使用 `/stats` 命令查看总令牌使用量。

## 常见错误消息及解决方案

- **错误：启动 MCP 服务器时出现 `EADDRINUSE`（地址已在使用中）。**
  - **原因：** 另一个进程已经在使用 MCP 服务器尝试绑定的端口。
  - **解决方案：**
    停止使用该端口的其他进程，或者配置 MCP 服务器使用不同的端口。

- **错误：找不到命令（尝试运行 Gemini CLI 时）。**
  - **原因：** Gemini CLI 未正确安装，或者未在系统的 PATH 中。
  - **解决方案：**
    1. 确保 Gemini CLI 安装成功。
    2. 如果是全局安装，请检查 npm 全局二进制目录是否在 PATH 中。
    3. 如果是从源代码运行，请确保使用正确的命令调用它（例如 `node packages/cli/dist/index.js ...`）。

- **错误：`MODULE_NOT_FOUND` 或导入错误。**
  - **原因：** 依赖项未正确安装，或者项目尚未构建。
  - **解决方案：**
    1. 运行 `npm install` 以确保所有依赖项都已安装。
    2. 运行 `npm run build` 以编译项目。

- **错误："操作不允许"、"权限被拒绝" 或类似错误。**
  - **原因：** 如果启用了沙盒功能，则应用程序可能正在尝试执行沙盒限制的操作，例如在项目目录或系统临时目录之外写入。
  - **解决方案：** 有关更多信息（包括如何自定义沙盒配置），请参阅 [沙盒](./cli/configuration.md#sandboxing)。

- **CLI 在 "CI" 环境中不具有交互性**
  - **问题：** 如果设置了以 `CI_` 开头的环境变量（例如 `CI_TOKEN`），则 CLI 不会进入交互模式（不会显示提示符）。这是因为底层 UI 框架使用的 `is-in-ci` 包检测到这些变量，并假定为非交互式 CI 环境。
  - **原因：** `is-in-ci` 包会检查是否存在 `CI`、`CONTINUOUS_INTEGRATION` 或任何以 `CI_` 为前缀的环境变量。当检测到这些变量时，它会表明环境为非交互式，从而阻止 CLI 以交互模式启动。
  - **解决方案：** 如果 `CI_` 前缀的变量对 CLI 运行并非必要，您可以暂时取消设置该变量再执行命令。例如：`env -u CI_TOKEN gemini`

## 调试提示

- **CLI 调试：**
  - 在 CLI 命令中使用 `--verbose` 标志（如果可用）以获取更详细的输出。
  - 检查 CLI 日志，通常在用户特定的配置或缓存目录中可以找到。

- **核心调试：**
  - 检查服务器控制台输出中的错误消息或堆栈跟踪。
  - 如果可配置，增加日志详细程度。
  - 如果需要逐步执行服务器端代码，可以使用 Node.js 调试工具（例如 `node --inspect`）。

- **工具问题：**
  - 如果某个特定工具失败，请尝试通过运行该工具执行的最简单命令或操作来隔离问题。
  - 对于 `run_shell_command`，请先检查命令是否可以直接在您的 shell 中正常运行。
  - 对于文件系统工具，请仔细检查路径和权限。

- **预检检查：**
  - 在提交代码之前，请始终运行 `npm run preflight`。这可以捕获许多与格式化、linting 和类型错误相关的常见问题。

如果您遇到此处未涵盖的问题，请考虑在 GitHub 上搜索项目的 issue tracker，或报告一个包含详细信息的新问题。